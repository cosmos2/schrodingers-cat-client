# ( ⓛ ω ⓛ \*) meooooooow

오늘할일 ( 8 월 14 일 화요일)

1. 고양이 고르는 창 만들기
2. 서버와 연결해서 테스트해보기
3. react-navigation 공부

오늘의 마무리

1. 위쪽에 구역 정보같은게 나오면 좋겠으나 구현가능할지는 모름. <Cat/> 컴포넌트를 따로 만들어서 안에서 부모 컴포넌트로 고양이 아이디를 올리는데 처음에 안들어가서 헤맸음. Cat 에서 state 에 담은 후에 넘기면 들어갔음.
2. 서버와 연결해서 테스트는 못했음.
3. 딴거 하느라 아직 못봤음.

# ( ⓛ ω ⓛ \*) meooooooow

오늘할일 ( 8 월 16 일 목요일)

1. 타이머 마무리
2. 클라이언트 모두 merge 하기
3. 시작시 socket.io jwt 로 토큰 확인하기

오늘의 마무리

1. 타이머를 setTimeout 으로 돌리면 오차가 많이 생겨서 컴포넌트를 두개로 나눠서 receiveProps 를 사용해서 구현했다. 오차를 잡음.

2. 유저 정보 받아오기

a. 처음에 앱을 시동했을 때 서버에서 유저정보를 받아와서 로컬 스토리지에 저장하려했으나, 이경우에는 채팅을 한 뒤에는 새로운 정보가 업데이트되지 않는다.
b. 그렇다면 채팅이 끝난 뒤에도 서버에서 유저 정보를 보내주면 업데이트된 정보를 얻을 수 있다. 하지만 이 경우에는 두번이나 요청을 보내야하기 때문에 효율적이지 못하다.
c. 따라서 유저정보가 필요한 순간, 프로필을 열람하는 순간에만 post 요청을 보내서 유저정보를 받는 것이 가장 최신 정보를 효율적으로 받을 수 있는 방법이라는 결론에 다다름.

3. 소켓을 여는 시점

a. 앱을 처음 구동했을때 첫페이지에서 소켓을 열어서 토큰을 보내는 방식이었다.
b. 그러나 고양이 선택 페이지에서는 소켓이 열리지 않음 그리고 첫번째부터 오픈 박스 페이지까지 소켓을 이동시켜야하는데 props 로 넘기는게 번거로움
c. 소켓이 필요한 순간은 채팅방이 열리는 순간이므로 오픈 박스 페이지에서 소켓을 열어 토큰과 위치정보를 보내고 채팅방 입장까지 전달하는 편이 가장 효율적인 것 같다.
d. 나머지 자잘한 정보들은 http 리퀘스트로 요청하는 편이 낫다. 계속 연결되어 있을 필요가 없음.
e. 그런데 context API 라는게 있다는걸 알게됨. 이걸 쓰면 전역으로 소켓을 빼놓을 수 있을 듯.

# ( ⓛ ω ⓛ \*) meooooooow

오늘할일 ( 8 월 17 일 금요일)

1. context API
2. 소켓연결
3. token 받아오기

오늘의 마무리

채팅방에 입장하는 부분에서만 소켓을 연결하려했으나 뒷단에서 쓰는 토큰이 소켓 전용 토큰이라 소켓으로 정보를 주고 받아야만 됨. 그래서 소켓을 전역에서 가져다 쓸 수 있는 방법을 찾다보니 리액트 16.3 부터는 context api 가 쓸만해져서 리덕스를 대체할 수 있다는 소릴 듣고 사용하기로 했음.

context api 도 <Store.Consumer>를 랜더 함수 밖에서 사용할 수 없어서 소켓을 불러올 수가 없었음. 그래서 최상단 컴포넌트에서 소켓을 연결한뒤 소켓을 스토어로 넘겨서 사용하려는 컴포넌트에서 소켓을 받아 외부함수의 인자로 넣어서 소켓 이벤트를 날리는 방법을 사용.

근데 또 문제가 생긴게 <Store.Consumer>를 사용할 수 없는 컴포넌트, 즉 액션이 하나도 없는 컴포넌트는 외부함수의 인자로 쓸 소켓을 받아올 수 가 없었다. 이건 아직 해결을 못함? 했나?

또 문제는 최상단 컴포넌트의 constructor 에서 소켓을 연결하는데 그 연결하는 시점에 토큰을 불러올 수가 없었다. asyncStorage 는 아이템을 불러오는데 시간이 걸리기 때문에 비동기 처리를 해야하는데 컨스트럭터 안에서는 비동기 처리가 불가능했다. 따라서 존나 삽질을 하다하다하다 안되서 최상단 컴포넌트인 App.js 와 appPresenter.js 를 하나 더 만들어서 app.js 에서 토큰을 가져와 props 로 appPresenter 로 넘겨줬다.

문제는 여기서 생겼다. componentDidMount 로 토큰을 받아서 setState 로 토큰을 담아 넘겨야하는데 밑에서 바뀐 스테이트가 넘어가질 않았다. 찾아보니 랜더될때 토큰이 박히지 않은 스테이트가 프롭으로 넘어가고 did mount 되면서 setState 로 토큰이 스테이트 박힌다. 스테이트가 바뀌니 재랜더가 되고 바뀐 스테이트가 다시 프롭으로 넘어가야 할 것 같은데 넘어가질 않는다. 그래서 스테이트가 바뀔때까지 기다렸다가 삼항연산자로 바뀐 뒤 스테이트를 프롭으로 넘겨줬다.
대체 이게 왜 안되는지 아직도 모르겠다.

시발

# ( ⓛ ω ⓛ \*) meooooooow

오늘의할일 (8 월 20 일 월요일)

1. 소켓관련 리펙토링
2. 남은 시간을 서버에서 받아오고 카운트하기

오늘의 마무리

앱을 다운받고 토큰이 없는 상황에서도 처음부터 소켓을 열 수 있는 방법을 찾았다. 앱을 시작할 때 토큰이 있는지 확인한 후 없으면 일단 토큰부터 받아오고 연결을 한다. 토큰을 저장하면서 처음시작하는 것이라는 걸 알 수 있도록 firstTime 이라는 이름으로 로컬 스토리지에 스트링을 저장한다. 그리고 고양이 선택 페이지로 넘긴뒤 고양이를 선택하면 그때 고양이 정보를 서버에 넘겨서 업데이트하고 firstTime 을 로컬에서 지운다. 그러면 언제든지 소켓을 처음부터 연결할 수 있고 context API 를 통해 전역에서 소켓을 관리할 수 있다. 지하철타고 출근하면서 생각한 방법인데 먹혀서 다행이다.

이제 채팅룸쪽도 다시 고치면서 어느정도 안정화가 되었고 타이머도 늦게 들어오는 사람들도 정확한(조금 오차는 있다) 시간을 알 수 있도록 서버에서 보내주는 남은 시간을 가지고 타이머를 리팩토링했다. 처음에 뭐가 문제였는지 엄청 꼬여가지고 계속 못하고 삽질만 하다가 잠깐 쉬면서 정리를 해보니 한줄만 고치면 되었다. 역시 너무 매몰되어 있으면 문제가 잘 보이지 않는다.
그건 그렇고 여전히 timepicker 로 프롭을 내려줄때 그냥 셋스테이트한건 왜 안내려가는지 정확히 모르겠다. 바뀐 값이 있어야만 내려가는 듯 하다.

나머지 자잘한 것들, 오류들 고치고 오늘 나름 완성도가 올라갔다.
